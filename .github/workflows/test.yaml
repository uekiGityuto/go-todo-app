on:
  push:
    branches:
      - "main"
  pull_request:
name: test
jobs:
    test:
      runs-on: ubuntu-latest
      services:
        mysql:
          image: mysql:8
          options: >-
            --health-cmd "mysqladmin ping -h localhost"
            --health-interval 20s
            --health-timeout 10s
            --health-retries 10
          ports:
            - 3306:3306
          env:
            MYSQL_ALLOW_EMPTY_PASSWORD: yes
            MYSQL_USER: todo
            MYSQL_PASSWORD: todo
            MYSQL_DATABASE: todo
        redis:
          image: redis:6.2
          options: >-
            --health-cmd "redis-cli ping"
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5
          ports:
            - 6379:6379
      steps:
        - uses: actions/setup-go@v3
          with:
            go-version: '>=1.18'
        - uses: actions/checkout@v3
        - run: |
            go install github.com/k0kubun/sqldef/cmd/mysqldef@latest
            mysqldef -u todo -p todo -h 127.0.0.1 -P 3306 todo < ./_tools/mysql/schema.sql
        - name: place the pem file
          env:
            PUBLIC_PEM: ${{ secrets.PUBLIC_PEM }}
            SECRET_PEM: ${{ secrets.SECRET_PEM }}
          run: |
            ls -l auth/cert
            echo $PUBLIC_PEM | base64 --decode > auth/cert/public_test.pem
            echo $SECRET_PEM | base64 --decode > auth/cert/secret_test.pem
            ls -l auth/cert
            diff auth/cert/public_test.pem auth/cert/public.pem
        - run: |
            go test ./... -coverprofile=coverage.out
          env:
            TODO_DB_PORT: 3306
            TODO_REDIS_PORT: 6379
        - name: report coverage
          uses: k1LoW/octocov-action@v0
